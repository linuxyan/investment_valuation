<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="/investment_valuation/stock.png" type="image/x-icon">
    <title>æŠ•èµ„ç»„åˆç®¡ç† - æŒä»“æ˜ç»†</title>
    <!-- å¼•å…¥ Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            max-width: 1400px;
        }
        .right {
            text-align: center;
        }
        .red {
            color: #e74c3c !important;
            font-weight: 600;
        }
        .green {
            color: #27ae60 !important;
            font-weight: 600;
        }
        
        /* è¡¨æ ¼æ ·å¼ä¼˜åŒ– - ç®€æ´é£æ ¼ */
        .table {
            border-radius: 4px;
            overflow: hidden;
            background: white;
            border: 1px solid #dee2e6;
        }
        .table thead th {
            background: #495057;
            color: white;
            border: none;
            font-weight: 600;
            padding: 12px 10px;
            font-size: 14px;
        }
        .table tbody tr {
            transition: background-color 0.2s ease;
        }
        .table tbody tr:hover {
            background-color: #f8f9fa;
        }
        .table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .table td {
            padding: 10px 8px;
            border-color: #dee2e6;
            vertical-align: middle;
        }
        
        /* å¼ºåˆ¶æ‰€æœ‰è¡¨å¤´å’Œå•å…ƒæ ¼å±…ä¸­æ˜¾ç¤º */
        table th,
        table td {
            text-align: center !important;
        }
        
        /* æ€»è®¡è¡Œç‰¹æ®Šæ ·å¼ */
        #summaryRow {
            font-weight: bold;
            background-color: #f8f9fa;
        }
        #summaryRow td {
            border-top: 2px solid #dee2e6;
        }
        
        /* å›¾è¡¨å®¹å™¨ä¼˜åŒ– */
        #trendChart {
            width: 100%;
            height: 400px;
            background: white;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            margin: 0 auto;
        }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .table-responsive {
                font-size: 12px;
            }
            .table th, .table td {
                padding: 8px 5px;
            }
            #trendChart {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container my-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">æŠ•èµ„ç»„åˆç®¡ç† - æŒä»“æ˜ç»† <span id="currentDate"></span></h1>
            <div>
                <button id="refreshBtn" class="btn btn-outline-primary btn-sm">
                    <span id="refreshIcon">ğŸ”„</span> åˆ·æ–°æ•°æ®
                </button>
                <span id="lastUpdate" class="text-muted ms-2" style="font-size: 12px;"></span>
            </div>
        </div>
        <div class="table-responsive" style="border-radius: 8px; overflow: hidden;">
            <table id="portfolioTable" class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th>è‚¡ç¥¨ä»£ç </th>
                        <th>è‚¡ç¥¨åç§°</th>
                        <th>æŒä»“æ•°é‡</th>
                        <th class="right">å½“å‰ä»·</th>
                        <th>ä»Šæ—¥æ¶¨è·Œå¹…</th>
                        <th class="right">ä»Šæ—¥ç›ˆäº</th>
                        <th class="right">æŒä»“å æ¯”</th>
                        <th class="right">æŒä»“å¸‚å€¼</th>
                    </tr>
                </thead>
                <tbody>
                    <tr id="loadingRow">
                        <td colspan="8" class="text-center py-4">
                            <div class="loading">
                                <div class="spinner"></div>
                                <p class="mt-2 mb-0">æ­£åœ¨åŠ è½½æŒä»“æ•°æ®...</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <hr style="border: 1px solid #ddd; margin: 40px 0;">
        <!-- æ·»åŠ å¸‚å€¼è¶‹åŠ¿å›¾ -->
        <div class="my-5">
            <div id="trendChart"></div>
        </div>
    </div>

    <script>
        // æ ¹æ®è‚¡ç¥¨ä»£ç åˆ¤æ–­å¸‚åœºå‰ç¼€
        function getMarketPrefix(stockCode) {
            if (stockCode.toLowerCase().startsWith("hk"))
                return "hk";
            return stockCode.startsWith("6") ? "sh" : "sz";
        }

        // å°†æ•°å­—æ ¼å¼åŒ–ä¸ºåƒåˆ†ä½
        function formatNumber(num) {
            return Number(num).toLocaleString();
        }

        // å…¨å±€å˜é‡ï¼šä¿å­˜åŠ¨æ€æ•°æ®çš„ DOM å¼•ç”¨åŠéƒ¨åˆ†é™æ€æ•°æ®
        let rowMapping = {};
        let stockIds = [];
        let staticLoaded = false;
        // é»˜è®¤æ¸¯å¸å…‘äººæ°‘å¸æ±‡ç‡ï¼Œç¨åé€šè¿‡æ¥å£æ›´æ–°
        let hkExchangeRate = 0.90;
        // è·å–å®æ—¶æ±‡ç‡ï¼ˆHKD -> CNYï¼‰
        fetch("https://api.exchangerate-api.com/v4/latest/HKD")
            .then(res => res.json())
            .then(data => {
                if(data && data.rates && data.rates.CNY) {
                    hkExchangeRate = data.rates.CNY;
                    // å®æ—¶æ±‡ç‡è·å–æˆåŠŸåç«‹å³è°ƒç”¨ updateMarketData() æ›´æ–°æ•°æ®
                    updateMarketData();
                }
            })
            .catch(err => console.error("æ±‡ç‡è·å–å¤±è´¥:", err));

        // é¦–æ¬¡åŠ è½½é™æ€æŒä»“æ•°æ®å¹¶æ„å»ºè¡¨æ ¼
        function loadStaticPortfolioData() {
            fetch("/investment_valuation/data/current_position.json?cb=" + new Date().getTime())
                .then(response => response.json())
                .then(data => {
                    document.getElementById("currentDate").textContent = "(" + data.date + ")";
                    const positions = data.positions;
                    const tbody = document.querySelector("#portfolioTable tbody");
                    
                    // ç§»é™¤åŠ è½½çŠ¶æ€
                    const loadingRow = document.getElementById("loadingRow");
                    if (loadingRow) {
                        loadingRow.remove();
                    }
                    
                    tbody.innerHTML = "";
                    rowMapping = {};
                    stockIds = [];
                    positions.forEach(position => {
                        const stockCode = position["è‚¡ç¥¨ä»£ç "];
                        const market = getMarketPrefix(stockCode);
                        let cleanCode = stockCode;
                        if (stockCode.toLowerCase().startsWith("hk")) {
                            cleanCode = stockCode.substring(2); // å»é™¤ "hk" å‰ç¼€
                        }
                        const stockId = market + cleanCode;
                        stockIds.push(stockId);

                        const tr = document.createElement("tr");
                        // è‚¡ç¥¨ä»£ç ï¼šæ”¯æŒç‚¹å‡»ï¼ˆæ­¤å¤„ç›´æ¥æ˜¾ç¤ºæ–‡æœ¬ï¼Œå¯æ ¹æ®éœ€è¦æ·»åŠ é“¾æ¥ï¼‰
                        const tdCode = document.createElement("td");
                        tdCode.textContent = stockCode;
                        tr.appendChild(tdCode);

                        const tdName = document.createElement("td");
                        tdName.textContent = position["è‚¡ç¥¨åç§°"];
                        tr.appendChild(tdName);

                        const tdQuantity = document.createElement("td");
                        tdQuantity.textContent = position["æŒä»“æ•°é‡"];
                        tr.appendChild(tdQuantity);

                        const tdCurrentPrice = document.createElement("td");
                        tdCurrentPrice.className = "right";
                        tr.appendChild(tdCurrentPrice);

                        const tdChange = document.createElement("td");
                        tr.appendChild(tdChange);

                        // æ–°å¢ï¼šä»Šæ—¥ç›ˆäºå•å…ƒæ ¼ï¼ˆå³å¯¹é½ï¼‰
                        const tdTodayProfit = document.createElement("td");
                        tdTodayProfit.className = "right";
                        tr.appendChild(tdTodayProfit);

                        const tdHoldingRatio = document.createElement("td");
                        tdHoldingRatio.className = "right";
                        tr.appendChild(tdHoldingRatio);

                        const tdMarketValue = document.createElement("td");
                        tdMarketValue.className = "right";
                        tr.appendChild(tdMarketValue);

                        tbody.appendChild(tr);

                        // ä¿å­˜å½“å‰è¡Œçš„ DOM å¼•ç”¨åŠæ‰€éœ€é™æ€æ•°æ®
                        rowMapping[stockId] = {
                            tdCurrentPrice,
                            tdChange,
                            tdTodayProfit,
                            tdHoldingRatio,
                            tdMarketValue,
                            // ä¿å­˜æŒä»“æ•°é‡ï¼ˆå·²ä» CSV è¯»å–ï¼‰
                            quantity: parseFloat(position["æŒä»“æ•°é‡"])
                        };
                    });
                    staticLoaded = true;
                    updateMarketData();
                })
                .catch(err => {
                    console.error("Error loading current_position.json:", err);
                    const tbody = document.querySelector("#portfolioTable tbody");
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <div style="color: #e74c3c;">
                                    <i style="font-size: 48px; margin-bottom: 10px;">âš ï¸</i>
                                    <p class="mb-1">æ•°æ®åŠ è½½å¤±è´¥</p>
                                    <small class="text-muted">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•</small>
                                </div>
                            </td>
                        </tr>
                    `;
                });
        }

        // åŠ¨æ€æ•°æ®åˆ·æ–°å‡½æ•°ï¼ˆä¸é‡æ„é™æ€è¡¨æ ¼ï¼‰
        function updateMarketData() {
            if (!staticLoaded || stockIds.length === 0) return;
            const apiUrl = `https://qt.gtimg.cn/q=${stockIds.join(',')}`;
            fetch(apiUrl)
                .then(response => response.text())
                .then(text => {
                    let items = text.split(";");
                    let newTotalMarketValue = 0; // ç´¯è®¡æ‰€æœ‰æŒä»“å¸‚å€¼
                    let totalTodayProfit = 0;    // ç´¯è®¡æ‰€æœ‰ä»Šæ—¥ç›ˆäº
                    items.forEach(item => {
                        if (item.trim().length === 0) return;
                        let identifier = item.substring(2, item.indexOf("="));
                        if (identifier.startsWith('_')) {
                            identifier = identifier.substring(1);
                        }
                        if (!rowMapping.hasOwnProperty(identifier)) {
                            console.warn("Identifier not found:", identifier);
                            return;
                        }
                        // å¯¹äºç°é‡‘æŒä»“ï¼ˆ"sz000000"ï¼‰è·³è¿‡ï¼Œç°é‡‘æŒä»“ç”±åé¢ç»Ÿä¸€æ›´æ–°
                        if (identifier === "sz000000") return;
                        let startQuote = item.indexOf('="');
                        if (startQuote === -1) return;
                        let endQuote = item.lastIndexOf('"');
                        if (endQuote === -1) return;
                        let content = item.substring(startQuote + 2, endQuote);
                        let parts = content.split('~');
                        if (parts.length < 4) return;
                        
                        let currentPrice = parseFloat(parts[3]);
                        // å¦‚æœ parts åŒ…å«ä»Šæ—¥æ¶¨è·Œå¹…æ•°æ®ï¼Œåˆ™ä½¿ç”¨ï¼›å¦åˆ™é»˜è®¤ 0
                        let todayChange = 0;
                        if (parts.length > 32) {
                            todayChange = parseFloat(parts[32]);
                        } else {
                            todayChange = 0;
                        }

                        const { quantity, tdCurrentPrice, tdChange, tdTodayProfit, tdHoldingRatio, tdMarketValue } = rowMapping[identifier];
                        let marketValue = currentPrice * quantity;
                        // è®¡ç®—ä»Šæ—¥ç›ˆäºï¼š (å½“å‰ä»· - æ˜¨æ—¥æ”¶ç›˜ä»·) Ã— æŒä»“æ•°é‡
                        let yesterdayClose = parseFloat(parts[4]);
                        let todayProfit = (currentPrice - yesterdayClose) * quantity;
                        // å¯¹äºæ¸¯è‚¡ï¼Œè½¬æ¢ä¸ºäººæ°‘å¸
                        if (identifier.startsWith("hk")) {
                            marketValue = marketValue * hkExchangeRate;
                            todayProfit = todayProfit * hkExchangeRate;
                        }
                        
                        // æ›´æ–°å½“å‰ä»·æ˜¾ç¤º
                        if (identifier.startsWith("hk")) {
                            tdCurrentPrice.textContent = "HK$" + formatNumber(currentPrice);
                            tdCurrentPrice.title = "æ¸¯å¸";
                        } else {
                            tdCurrentPrice.textContent = formatNumber(currentPrice);
                        }
                        tdChange.textContent = todayChange.toFixed(2) + '%';
                        tdChange.className = "";
                        tdChange.classList.add(todayChange >= 0 ? "red" : "green");
                        tdTodayProfit.textContent = formatNumber(todayProfit);
                        tdTodayProfit.className = "";
                        tdTodayProfit.classList.add(todayProfit >= 0 ? "red" : "green");
                        tdMarketValue.textContent = formatNumber(marketValue);
                        tdMarketValue.className = "right";
                        rowMapping[identifier].marketValue = marketValue;
                        
                        rowMapping[identifier].todayChange = todayChange;
                        totalTodayProfit += todayProfit;
                        newTotalMarketValue += marketValue;
                    });
                    
                    // æ›´æ–°ç°é‡‘æŒä»“æ•°æ®ï¼ˆè‹¥å­˜åœ¨ï¼‰
                    if (rowMapping.hasOwnProperty("sz000000")) {
                        let cashData = rowMapping["sz000000"];
                        let currentPrice = 1.0;
                        let quantity = cashData.quantity;
                        let marketValue = currentPrice * quantity;
                        let todayProfit = 0;  // å›ºå®šä¸º0
                        
                        cashData.tdCurrentPrice.textContent = formatNumber(currentPrice);
                        cashData.tdCurrentPrice.title = "";
                        cashData.tdChange.textContent = "0.00%";
                        cashData.tdChange.className = "";
                        cashData.tdChange.classList.add("red");
                        cashData.tdTodayProfit.textContent = formatNumber(todayProfit);
                        cashData.tdTodayProfit.className = "";
                        cashData.tdTodayProfit.classList.add("red");
                        cashData.tdMarketValue.textContent = formatNumber(marketValue);
                        cashData.tdMarketValue.className = "right";
                        cashData.marketValue = marketValue; // ä¿å­˜ç°é‡‘æŒä»“å¸‚å€¼
                        cashData.todayChange = 0;
                        newTotalMarketValue += marketValue;
                        totalTodayProfit += todayProfit;
                    }

                    // æ›´æ–°æ¯æ”¯è‚¡ç¥¨çš„æŒä»“å æ¯”
                    for (let id in rowMapping) {
                        let ratio = "0.00%";
                        if (newTotalMarketValue > 0) {
                            ratio = ((rowMapping[id].marketValue / newTotalMarketValue) * 100).toFixed(2) + "%";
                        }
                        rowMapping[id].tdHoldingRatio.textContent = ratio;
                    }

                    // å¯é€‰ï¼šè®¡ç®—æ•´ä½“åŠ æƒä»Šæ—¥æ¶¨è·Œå¹…
                    let weightedChangeSum = 0;
                    for (let id in rowMapping) {
                        if (rowMapping[id].todayChange !== undefined) {
                            weightedChangeSum += rowMapping[id].todayChange * rowMapping[id].marketValue;
                        }
                    }
                    let overallTodayChange = 0;
                    if (newTotalMarketValue > 0) {
                        overallTodayChange = weightedChangeSum / newTotalMarketValue;
                    }

                    // ç”Ÿæˆ Summary è¡Œï¼ˆå…±8åˆ—ï¼‰
                    let tbody = document.querySelector("#portfolioTable tbody");
                    let summaryRow = document.getElementById("summaryRow");
                    if (!summaryRow) {
                        summaryRow = document.createElement("tr");
                        summaryRow.id = "summaryRow";
                        tbody.appendChild(summaryRow);
                    }
                    summaryRow.innerHTML = "";
                    // ç”Ÿæˆ Summary è¡Œï¼ˆ8åˆ—ï¼šè‚¡ç¥¨ä»£ç ã€è‚¡ç¥¨åç§°ã€æŒä»“æ•°é‡ã€å½“å‰ä»·ã€ä»Šæ—¥æ¶¨è·Œå¹…ã€ä»Šæ—¥ç›ˆäºã€æŒä»“å æ¯”ã€æŒä»“å¸‚å€¼ï¼‰
                    // åˆ—1ï¼šæ˜¾ç¤º "æ€»è®¡"
                    let tdTotal = document.createElement("td");
                    tdTotal.textContent = "æ€»è®¡";
                    summaryRow.appendChild(tdTotal);

                    // åˆ—2åˆ°åˆ—4ï¼šç©ºç™½ï¼ˆåˆ†åˆ«å¯¹åº” è‚¡ç¥¨åç§°ã€æŒä»“æ•°é‡ã€å½“å‰ä»·ï¼‰
                    for (let i = 0; i < 3; i++){
                        let tdBlank = document.createElement("td");
                        tdBlank.textContent = "";
                        summaryRow.appendChild(tdBlank);
                    }

                    // åˆ—5ï¼šæ•´ä½“åŠ æƒä»Šæ—¥æ¶¨è·Œå¹…ï¼ˆæŒ‰ç…§å„è¡Œå¸‚å€¼åŠ æƒè®¡ç®—ï¼Œæ˜¾ç¤ºç™¾åˆ†æ¯”ï¼‰
                    let tdOverallChange = document.createElement("td");
                    tdOverallChange.className = "right";
                    tdOverallChange.textContent = overallTodayChange.toFixed(2) + "%";
                    tdOverallChange.style.fontWeight = "bold";
                    if (overallTodayChange >= 0) {
                        tdOverallChange.style.color = "red";
                    } else {
                        tdOverallChange.style.color = "green";
                    }
                    summaryRow.appendChild(tdOverallChange);

                    // åˆ—6ï¼šç´¯è®¡ä»Šæ—¥ç›ˆäº
                    let tdTotalTodayProfit = document.createElement("td");
                    tdTotalTodayProfit.className = "right";
                    tdTotalTodayProfit.textContent = formatNumber(totalTodayProfit.toFixed(2));
                    tdTotalTodayProfit.style.fontWeight = "bold";
                    if (totalTodayProfit >= 0) {
                        tdTotalTodayProfit.style.color = "red";
                    } else {
                        tdTotalTodayProfit.style.color = "green";
                    }
                    summaryRow.appendChild(tdTotalTodayProfit);

                    // åˆ—7ï¼šæŒä»“å æ¯”ï¼ˆå›ºå®š 100%ï¼‰
                    let tdTotalRatio = document.createElement("td");
                    tdTotalRatio.className = "right";
                    tdTotalRatio.textContent = "100%";
                    summaryRow.appendChild(tdTotalRatio);

                    // åˆ—8ï¼šæ€»æŒä»“å¸‚å€¼
                    let tdTotalMarketValue = document.createElement("td");
                    tdTotalMarketValue.className = "right";
                    tdTotalMarketValue.textContent = formatNumber(newTotalMarketValue);
                    summaryRow.appendChild(tdTotalMarketValue);
                })
                .catch(err => console.error("Error fetching batch stock data:", err));
        }

        // é¦–æ¬¡åŠ è½½é™æ€æ•°æ®
        loadStaticPortfolioData();
        // åˆ·æ–°æŒ‰é’®åŠŸèƒ½
        document.getElementById('refreshBtn').addEventListener('click', function() {
            const btn = this;
            const icon = document.getElementById('refreshIcon');
            const originalIcon = icon.textContent;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            btn.disabled = true;
            icon.textContent = 'â³';
            btn.classList.add('disabled');
            
            // æ‰§è¡Œåˆ·æ–°
            updateMarketData();
            
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            setTimeout(() => {
                btn.disabled = false;
                icon.textContent = originalIcon;
                btn.classList.remove('disabled');
            }, 1000);
        });
        
        // æ›´æ–°æœ€ååˆ·æ–°æ—¶é—´
        function updateLastRefreshTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('lastUpdate').textContent = `æœ€åæ›´æ–°: ${timeStr}`;
        }
        
        // æ¯10ç§’åˆ·æ–°åŠ¨æ€æ•°æ®
        setInterval(function() {
            updateMarketData();
            updateLastRefreshTime();
        }, 10000);
        
        // åˆå§‹æ›´æ–°æ—¶é—´
        setTimeout(updateLastRefreshTime, 1000);
    </script>
    <!-- å¼•å…¥ ECharts -->
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/6.0.0/echarts.common.min.js"></script>
    <script>
        // ä» market_trend.json æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼Œå¹¶ç»˜åˆ¶è¶‹åŠ¿å›¾
        fetch("/investment_valuation/data/market_trend.json?cb=" + new Date().getTime())
            .then(response => response.json())
            .then(data => {
                if (!data || data.length === 0) {
                    document.getElementById('trendChart').innerHTML = '<div class="loading"><div class="spinner"></div><p>æš‚æ— è¶‹åŠ¿æ•°æ®</p></div>';
                    return;
                }
                
                // æŒ‰æ—¥æœŸæ’åº
                data.sort((a, b) => new Date(a.date) - new Date(b.date));
                const dates = data.map(item => item.date);
                const values = data.map(item => item.portfolio_value);
                const costs = data.map(item => item.investment_cost);
                
                // è®¡ç®—ç»„åˆå‡€å€¼æ•°æ®ï¼ˆä»¥åˆå§‹æˆæœ¬ä¸ºåŸºå‡†1.0ï¼‰
                const netValues = values.map((value, index) => {
                    const initialCost = costs[0]; // ä½¿ç”¨åˆå§‹æˆæœ¬ä½œä¸ºåŸºå‡†
                    return initialCost > 0 ? (value / initialCost).toFixed(4) : 1.0;
                });

                // åˆå§‹åŒ– ECharts å®ä¾‹
                var myChart = echarts.init(document.getElementById('trendChart'));

                // å®šä¹‰å›¾è¡¨é…ç½®
                const option = {
                    title: {
                        text: 'æŠ•èµ„ç»„åˆè¶‹åŠ¿åˆ†æ',
                        left: 'center',
                        textStyle: {
                            fontSize: 18,
                            fontWeight: 'bold',
                            color: '#2c3e50'
                        }
                    },
                    tooltip: {
                        trigger: 'axis',
                        backgroundColor: 'rgba(255,255,255,0.95)',
                        borderColor: '#ddd',
                        borderWidth: 1,
                        textStyle: {
                            color: '#333'
                        },
                        formatter: function(params) {
                            let result = `<div style="font-weight:bold;margin-bottom:8px;">${params[0].axisValue}</div>`;
                            params.forEach(param => {
                                const value = param.value.toLocaleString();
                                const marker = `<span style="display:inline-block;width:10px;height:10px;background:${param.color};border-radius:50%;margin-right:5px;"></span>`;
                                result += `${marker}${param.seriesName}: ${value}<br/>`;
                            });
                            return result;
                        }
                    },
                    legend: {
                        data: ['å¸‚å€¼', 'æˆæœ¬', 'ç»„åˆå‡€å€¼'],
                        top: 40,
                        right: '5%',
                        textStyle: {
                            fontSize: 12
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '8%',
                        top: '15%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: dates,
                        axisLabel: {
                            fontSize: 11,
                            color: "#666",
                            rotate: 45
                        },
                        axisLine: {
                            lineStyle: {
                                color: "#ddd"
                            }
                        },
                        axisTick: {
                            alignWithLabel: true
                        }
                    },
                    yAxis: [{
                        type: 'value',
                        name: 'é‡‘é¢',
                        position: 'left',
                        axisLabel: {
                            formatter: function(value) {
                                if (value >= 10000) {
                                    return (value / 10000).toFixed(1) + 'ä¸‡';
                                }
                                return value.toLocaleString();
                            },
                            fontSize: 11,
                            color: "#666"
                        },
                        axisLine: {
                            lineStyle: {
                                color: "#ddd"
                            }
                        },
                        splitLine: {
                            lineStyle: {
                                color: "rgba(200,200,200,0.3)"
                            }
                        }
                    }, {
                        type: 'value',
                        name: 'ç»„åˆå‡€å€¼',
                        position: 'right',
                        axisLabel: {
                            formatter: '{value}',
                            fontSize: 11,
                            color: "#666"
                        },
                        axisLine: {
                            lineStyle: {
                                color: "#ddd"
                            }
                        },
                        splitLine: {
                            show: false
                        }
                    }],
                    dataZoom: [{
                        type: 'inside',
                        start: Math.max(0, (dates.length - 90) / dates.length * 100),
                        end: 100
                    }, {
                        type: 'slider',
                        show: true,
                        bottom: '2%',
                        height: 20,
                        handleSize: 15,
                        handleStyle: {
                            color: '#667eea'
                        }
                    }],
                    series: [{
                        name: 'å¸‚å€¼',
                        type: 'line',
                        smooth: true,
                        data: values,
                        itemStyle: {
                            color: '#e74c3c'
                        },
                        lineStyle: {
                            width: 2
                        },
                        symbol: 'circle',
                        symbolSize: 4
                    },
                    {
                        name: 'æˆæœ¬',
                        type: 'line',
                        smooth: true,
                        data: costs,
                        itemStyle: {
                            color: '#3498db'
                        },
                        lineStyle: {
                            width: 2
                        },
                        symbol: 'circle',
                        symbolSize: 4
                    },
                    {
                        name: 'ç»„åˆå‡€å€¼',
                        type: 'line',
                        yAxisIndex: 1,
                        smooth: true,
                        data: netValues,
                        itemStyle: {
                            color: '#27ae60'
                        },
                        lineStyle: {
                            width: 1.5,
                            type: 'dashed'
                        },
                        symbol: 'emptyCircle',
                        symbolSize: 3
                    }]
                };

                myChart.setOption(option);
                
                // çª—å£å¤§å°å˜åŒ–æ—¶è‡ªåŠ¨è°ƒæ•´å›¾è¡¨å¤§å°
                window.addEventListener('resize', function() {
                    myChart.resize();
                });
            })
            .catch(error => {
                console.error("Error loading market_trend.json:", error);
                document.getElementById('trendChart').innerHTML = '<div class="loading"><p style="color:#e74c3c;">æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p></div>';
            });
    </script>
</body>
</html> 